<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½çç³»çµ± V4.5 (ä¿®æ­£ç‰ˆ)</title>
    <style>
        /* --- å…¨å±€è¨­ç½®èˆ‡é…è‰² --- */
        :root {
            --primary-color: #4CAF50; /* ä¸»ç¶ è‰² */
            --secondary-color: #81C784; /* æ·ºç¶ è‰² */
            --background-dark: #1E3A24; /* æ·±ç¶ èƒŒæ™¯ */
            --background-light: #2E4E34; /* æ·ºç¶ å€å¡ŠèƒŒæ™¯ */
            --text-color: #E0E0E0; /* æ·ºç°æ–‡å­— */
            --light-text-color: #FFFFFF; /* ç™½è‰²æ–‡å­— */
            --accent-color: #FFC107; /* è¼”åŠ©è‰²/é‡‘è‰² (é»ƒè‰²) */
            --lotto-red: #D32F2F; /* æ¨‚é€ç´… */
            --border-color: #4CAF50; /* é‚Šæ¡†é¡è‰² */
            --glass-background-dark: rgba(46, 78, 52, 0.7); /* è¼ƒæš—çš„ç»ç’ƒèƒŒæ™¯ */
            --glass-background-light: rgba(69, 107, 75, 0.9); /* è¼ƒäº®çš„ç»ç’ƒèƒŒæ™¯ for item focus */

            /* æ–°å¢æŒ‰éˆ•é¡è‰² */
            --button-add: #2196F3; /* è—è‰² */
            --button-update: #FFC107; /* é»ƒè‰² */
            --button-delete: #F44336; /* ç´…è‰² */
            --button-move: #9C27B0; /* ç´«è‰² */
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background-color: var(--background-dark);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 95%;
            max-width: 1600px; 
            margin: 0 auto;
            background: var(--background-light);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        
        h1, h2, h3 {
            color: var(--light-text-color);
            text-align: center;
            margin-bottom: 20px;
        }

        #version-display {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: var(--text-color);
            opacity: 0.8;
            font-size: 0.9em;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            z-index: 100;
        }
        
        #frontend-view {
            display: flex;
            flex-direction: column; 
        }

        /* --- é ‚éƒ¨åˆ‡æ›æŒ‰éˆ• --- */
        .mode-switcher {
            text-align: center;
            margin-bottom: 30px;
        }

        .mode-switcher button {
            padding: 12px 25px;
            margin: 0 10px;
            background: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .mode-switcher button:hover {
            background: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .mode-switcher button.active {
            background: var(--accent-color);
            color: var(--background-dark);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.5);
        }

        /* --- å¾Œå°ç®¡ç†é é¢æ¨£å¼ --- */
        #backend-view {
            padding: 25px;
            border: 1px solid var(--secondary-color);
            border-radius: 12px;
            background: var(--glass-background-dark);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.4);
        }

        .backend-section {
            margin-bottom: 30px;
            padding: 20px;
            border-left: 5px solid var(--primary-color);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .backend-section h3 {
            color: var(--secondary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px;
            margin-top: 0;
            text-align: left;
            font-size: 1.5em;
        }
        
        /* çµ±ä¸€çš„è¼¸å…¥/é¸å–®æ¨£å¼ */
        input[type="text"], input[type="number"], select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--secondary-color);
            background: #3c5d42; /* è¼ƒæ·±çš„ç¶ è‰² */
            color: var(--light-text-color); 
            width: calc(100% - 22px);
            box-sizing: border-box;
            font-size: 1em;
        }
        
        /* å¾Œå°è¡¨æ ¼ä¸­çš„å° input */
        .backend-table input[type="number"] {
            width: 60px; 
            padding: 5px;
            text-align: center; 
            background: #3c5d42; 
            color: var(--light-text-color); 
            border: 1px solid var(--border-color); 
            border-radius: 4px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--light-text-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            margin-top: 10px;
            min-width: 100px;
        }
        .add-btn { background: var(--button-add); }
        .update-btn { background: var(--button-update); }
        .delete-btn { background: var(--button-delete); }
        .move-btn { 
            background: var(--button-move); 
            padding: 5px 10px; 
            min-width: 0;
            margin: 2px;
        }
        
        .add-btn:hover { background: #1976D2; }
        .update-btn:hover { background: #FFB300; }
        .delete-btn:hover { background: #D32F2F; }
        .move-btn:hover { background: #7B1FA2; }

        /* å¾Œå°ä½ˆå±€çµ„ */
        .setting-group {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
        }
        .admin-input-group {
             display: flex;
             gap: 15px;
             align-items: center;
             margin-bottom: 15px;
             flex-wrap: wrap;
        }
        .admin-input-group input {
            flex-grow: 1;
            min-width: 150px;
            margin-top: 0;
            margin-bottom: 0;
            width: auto;
        }
        .admin-input-group input[type="number"] {
            min-width: 80px;
            flex-grow: 0;
        }
        .admin-input-group button {
            margin-top: 0;
            flex-shrink: 0;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-group select {
             width: auto;
             flex-grow: 1;
             margin-top: 10px;
        }
        .filter-group button {
            margin-top: 0;
            flex-shrink: 0;
        }


        /* å¾Œå°è¡¨æ ¼æ¨£å¼ */
        .backend-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
        }
        .backend-table th, .backend-table td {
            border: 1px solid #444;
            padding: 12px;
            text-align: left;
            font-size: 0.95em;
        }
        .backend-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        .backend-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .prize-move-buttons {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* --- å‰å°æ§åˆ¶å€å¡Š V4.21: å–®è¡Œæ§åˆ¶é … + ç¨ç«‹æŒ‰éˆ• --- */
        .controls {
            display: flex;
            flex-direction: column; 
            gap: 15px; 
            margin-bottom: 30px;
            padding: 20px 10px;
            background: var(--glass-background-dark);
            border-radius: 12px;
        }

        .controls-line-1 {
            display: flex;
            flex-wrap: wrap; 
            gap: 15px; 
            overflow-x: auto; 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
            padding-bottom: 5px; 
        }
        
        .controls-line-1::-webkit-scrollbar {
            display: none; 
        }
        
        .control-group {
             flex-shrink: 1; 
             flex-grow: 1; 
             min-width: 120px; 
             box-sizing: border-box;
        }
        
        /* å‰å°çš„ input/select æ¨£å¼ */
        .controls select, .controls input[type="number"] {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: #3c5d42;
            color: var(--light-text-color);
            font-size: 1em;
            width: 100%; 
            box-sizing: border-box;
        }
        
        #drawButton {
            width: 100%; 
            padding: 15px 25px; 
            font-size: 1.5em; 
            font-weight: bold;
            border-radius: 8px;
            
            background: var(--accent-color);
            color: var(--background-dark);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* --- æŠ½çä¸»ç•«é¢ä½ˆå±€ (3:6:3 æ¯”ä¾‹) --- */
        .main-content {
            display: flex; 
            gap: 20px;
            align-items: flex-start;
        }

        .marquee-sidebar {
            flex: 3; 
            min-width: 180px;
            padding: 15px;
            background: var(--glass-background-dark);
            border-radius: 12px;
            height: 600px; 
            overflow-y: auto;
            position: relative;
            
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        
        .marquee-sidebar::-webkit-scrollbar { display: none; }
        
        .marquee-sidebar h3 {
            margin-top: 0;
            font-size: 1.2em;
            color: var(--accent-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .marquee-sidebar.disabled-interaction {
             pointer-events: none;
             opacity: 0.8;
        }

        .central-display {
            flex: 6; 
            min-height: 600px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 30px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        /* --- æ‹‰éœ¸æ©Ÿæ¨£å¼ --- */
        .slot-machine {
            display: flex;
            gap: 10px;
            height: 150px; 
            margin: 50px 0 20px 0; 
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.8) inset;
        }

        .reel-container {
            width: 80px;
            height: 100%;
            overflow: hidden;
            border: 2px solid var(--accent-color);
            border-radius: 8px;
            position: relative;
        }
        .reel {
            position: absolute;
            top: 0;
            width: 100%;
            transition: transform 0.1s linear; 
        }

        .reel-number {
            height: 150px; 
            line-height: 150px;
            text-align: center;
            font-size: 4em;
            font-weight: bold;
            color: var(--accent-color);
            background: rgba(0, 0, 0, 0.7);
        }
        
        /* --- æ–çæ©Ÿ (Lotto Drum) æ¨£å¼ --- */
        .lotto-drum-container {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .lotto-drum-machine {
            width: 400px; 
            height: 400px; 
            /* !!! è«‹ç¢ºä¿ 'æ–çæ©Ÿ.jpg' æª”æ¡ˆèˆ‡æ­¤ HTML æª”æ¡ˆåœ¨åŒä¸€å€‹ç›®éŒ„ä¸‹ !!! */
            background-image: url('æ–çæ©Ÿ.jpg'); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            transition: transform 0.5s ease-out;
            margin-bottom: 50px; 
        }
        
        /* è½‰å‹•å‹•ç•« */
        .lotto-drum-machine.spinning {
            animation: drum-spin 0.3s linear infinite; 
        }
        
        .lotto-drum-machine.slow-stop {
            animation: drum-spin 2s ease-out 1;
            animation-fill-mode: forwards;
        }

        @keyframes drum-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .lotto-drum-results {
            display: flex;
            gap: 15px;
            z-index: 10; 
            min-height: 80px;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .lotto-ball-result { 
            width: 80px; 
            height: 80px; 
            line-height: 80px;
            border-radius: 50%;
            background: var(--lotto-red);
            color: white;
            font-size: 2em; 
            font-weight: bold;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            transform: scale(0); 
            animation: ball-pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes ball-pop-in {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* --- çµæœ/ä½”ä½ç¬¦æ¨£å¼ --- */
        .result-box.hidden { 
            opacity: 0; 
            /* ä¿®æ­£å°é½Šé»åˆ°ä¸­å¿ƒï¼šçµåˆç½®ä¸­å’Œç¸®æ”¾çš„ Transform */
            transform: translate(-50%, -50%) scale(0.8); 
        }
        .result-box {
            transition: all 0.5s ease-out;
            text-align: center;
            padding: 20px 40px;
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 10px;
            border: 1px solid var(--accent-color);
            z-index: 5;
            position: absolute; /* ä½¿å…¶ç–Šåœ¨å‹•ç•«ä¸Šæ–¹ */
            top: 50%;
            left: 50%;
            /* ç¢ºä¿å¯è¦‹ç‹€æ…‹çš„ Transform åŒ…å«ç½®ä¸­å’Œç¸®æ”¾ 1ï¼Œä½¿è½‰å ´å¹³æ»‘ä¸”ä»¥ä¸­å¿ƒç‚ºå°é½Šé» */
            transform: translate(-50%, -50%) scale(1); 
        }
        .winning-title {
            font-size: 3em;
            color: var(--accent-color);
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
        }
        .winning-prize {
            font-size: 1.8em;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }
        .winning-name {
            font-size: 4em;
            font-weight: bold;
            color: var(--light-text-color);
            margin-bottom: 10px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.7);
        }
        .winning-details {
            font-size: 1.2em;
            color: var(--text-color);
        }

        .placeholder { 
            font-size: 2.2em; 
            color: #B0BEC5; 
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .placeholder.hidden {
            display: none; 
        }
        
        /* --- è·‘é¦¬ç‡ˆé …ç›®æ¨£å¼ --- */
        .marquee-item { 
            padding: 12px; 
            margin-bottom: 10px; 
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px; 
            font-size: 1em; 
            border-left: 5px solid transparent; 
            transition: all 0.3s ease; 
            cursor: pointer;
            position: relative;
            overflow: hidden;
            color: var(--text-color); 
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.8);
        }
        
        .marquee-item.focus-animate { 
            background: var(--glass-background-light); 
            backdrop-filter: blur(5px); 
            -webkit-backdrop-filter: blur(5px);
            border-left: 5px solid var(--accent-color); 
            transform: scale(1.03); 
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.7); 
            color: var(--light-text-color); 
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>æŠ½çç³»çµ±</h1>
    </header>
    
    <div class="mode-switcher">
        <button id="btn-frontend" class="active" onclick="switchView('frontend')">ğŸ’ å‰å°æŠ½ç</button>
        <button id="btn-backend" onclick="switchView('backend')">âš™ï¸ å¾Œå°ç®¡ç†</button>
    </div>

    <div id="frontend-view" style="display: flex;">
        <div class="controls">
            <div class="controls-line-1">
                <div class="control-group">
                    <label for="eventSelect">é¸æ“‡æ´»å‹•:</label>
                    <select id="eventSelect" onchange="loadEventData()"></select>
                </div>
                <div class="control-group">
                    <label for="prizeSelect">é¸æ“‡çé … (å‰©é¤˜æ•¸é‡):</label>
                    <select id="prizeSelect"></select>
                </div>
                <div class="control-group">
                    <label for="drawType">æŠ½çæ–¹å¼:</label>
                    <select id="drawType">
                        <option value="single">å–®æ¬¡æŠ½ç</option>
                        <option value="continuous">é€£çºŒæŠ½ç</option>
                        <option value="batch">æ‰¹æ¬¡å±•ç¤º</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="animationType">å‹•ç•«é¡å‹:</label>
                    <select id="animationType">
                        <option value="slot">æ‹‰éœ¸æ©Ÿ</option>
                        <option value="lotto-drum">æ–çæ©Ÿ</option> 
                    </select>
                </div>
				
                <div class="control-group">
                    <label for="adminSelect">é•·å®˜æŠ½ç:</label>
                    <select id="adminSelect"></select>
                </div>
                <div class="control-group">
                    <label for="drawCount">æŠ½ç/å±•ç¤ºæ•¸é‡:</label>
                    <input type="number" id="drawCount" value="1" min="1" max="10">
                </div>
                <div class="control-group">
                    <label for="displaySeconds">é¡¯ç¤ºç§’æ•¸:</label>
                    <input type="number" id="displaySeconds" value="2" min="1" step="0.5">
                </div>
            </div>
            <button id="drawButton" onclick="startRaffle()">ğŸ‰ é–‹å§‹æŠ½ç ğŸ‰</button>
        </div>

        <div class="main-content">
            <div id="leftMarqueeSidebar" class="marquee-sidebar">
                <h3>ğŸ† å·²ä¸­çåå–®</h3>
                <div id="leftMarquee"></div>
            </div>

            <div class="central-display">
                <div id="slot-container" class="slot-machine" style="display: none;">
                </div> 

                <div id="lotto-container" class="lotto-drum-container" style="display: none;">
                    <div class="lotto-drum-machine" id="lotto-drum"></div>
                    <div class="lotto-drum-results" id="lotto-drum-results"></div>
                </div>

                <div id="resultBox" class="result-box hidden">
                    <h2 class="winning-title">æ­å–œä¸­çï¼</h2>
                    <p id="winningPrize" class="winning-prize"></p>
                    <p class="winning-name" id="winningName"></p>
                    <p id="winningDetails" class="winning-details"></p>
                </div>

                <div id="placeholder" class="placeholder">è«‹é»æ“Šé–‹å§‹æŠ½ç</div>
            </div>
            
            <div id="rightMarqueeSidebar" class="marquee-sidebar">
                <h3>ğŸ† å·²ä¸­çåå–®</h3>
                <div id="rightMarquee"></div>
            </div>
        </div>
    </div>
    
    <div id="backend-view" style="display: none;">
        <h2>âš™ï¸ ç³»çµ±å¾Œå°ç®¡ç†</h2>
        <div class="backend-section">
            <h3>æ´»å‹•è¨­å®šèˆ‡é¸æ“‡</h3>
            <div class="setting-group">
                <label for="currentEventSelect">é¸æ“‡ç•¶å‰æ´»å‹•:</label>
                <select id="currentEventSelect" onchange="loadEventData()"></select>
            </div>
            <div class="setting-group">
                <label for="newEventName">æ–°å¢æ´»å‹•åç¨±:</label>
                <input type="text" id="newEventName" placeholder="ä¾‹å¦‚: 2026 æ˜¥é…’">
                <button onclick="addEvent()" class="add-btn">æ–°å¢æ´»å‹•</button>
            </div>
            <div class="setting-group">
                <label for="allowDuplicateWin">æ˜¯å¦å…è¨±åŒè³‡æ–™é‡è¤‡ä¸­ç:</label>
                <select id="allowDuplicateWin">
                    <option value="false">å¦ (ä¸­çå¾Œç§»é™¤æŠ½çæ± )</option>
                    <option value="true">æ˜¯ (ä¸­çå¾Œä¿ç•™æŠ½çæ± )</option>
                </select>
                <button onclick="updateEventSetting()" class="update-btn">æ›´æ–°è¨­å®š</button>
                <button onclick="deleteAllWinners()" class="delete-btn">æ¸…é™¤æ‰€æœ‰ä¸­çç´€éŒ„ (æ‰€æœ‰æ´»å‹•)</button>
            </div>
        </div>
        
        <div class="backend-section">
            <h3>çé …è¨­å®š</h3>
            <div class="admin-input-group">
                <input type="text" id="prizeName" placeholder="çé …åç¨± (e.g., é ­ç)">
                <input type="text" id="prizeContent" placeholder="çå“å…§å®¹ (e.g., 55å‹é›»è¦–)">
                <input type="number" id="prizeQuantity" placeholder="ç¸½æ•¸é‡" min="1" value="1">
                <input type="number" id="prizeWeight" placeholder="æ¬Šé‡ (è¶Šé«˜è¶Šå®¹æ˜“æŠ½ä¸­, é è¨­ 1)" min="1" value="1">
                <button onclick="addPrize()" class="add-btn">æ–°å¢çé …</button>
            </div>
            <h4>ç•¶å‰çé …åˆ—è¡¨ (ç”±ä¸Šåˆ°ä¸‹ä¾åºé¡¯ç¤ºåœ¨å‰ç«¯æ¸…å–®)</h4>
            <table class="backend-table">
                <thead><tr><th>åç¨±</th><th>å…§å®¹</th><th>ç¸½æ•¸é‡</th><th>å‰©é¤˜æ•¸é‡</th><th>æ¬Šé‡</th><th>é †åºèª¿æ•´</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="prizesTable"></tbody>
            </table>
        </div>

        <div class="backend-section">
            <h3>æŠ½çé•·å®˜è¨­å®š (ç´¯åŠ æ¸…å–®)</h3>
            <div class="admin-input-group">
                <input type="text" id="adminName" placeholder="é•·å®˜å§“å (e.g., ç¸½ç¶“ç†)">
                <input type="number" id="adminChances" placeholder="æŠ½çæ¬¡æ•¸" min="1" value="1">
                <button onclick="addAdminChances()" class="add-btn">æ–°å¢/æ›´æ–°</button>
            </div>
            <h4>é•·å®˜æŠ½çæ¬¡æ•¸æ¸…å–®</h4>
            <table class="backend-table">
                <thead><tr><th>é•·å®˜å§“å</th><th>ç¸½æ¬¡æ•¸</th><th>å‰©é¤˜æ¬¡æ•¸</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="adminListTable"></tbody>
            </table>
        </div>

        <div class="backend-section">
            <h3>ä¸­çæ¸…å–®</h3>
            <div class="filter-group">
                <label for="winnerPrizeFilter">ä¾çé …ç¯©é¸:</label>
                <select id="winnerPrizeFilter" onchange="updateBackendDisplay()"></select>
                <button onclick="deleteAllWinners()" class="delete-btn">æ¸…é™¤æ‰€æœ‰ä¸­çç´€éŒ„</button>
            </div>
            <table class="backend-table">
                <thead><tr><th>æ™‚é–“</th><th>å·¥è™Ÿ</th><th>å§“å</th><th>çé …</th><th>æŠ½çé•·å®˜</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="winnersTable"></tbody>
            </table>
        </div>
        
        <div class="backend-section">
            <h3>åƒè³½è€…æ¸…å–® (æ¨¡æ“¬å·¥è™Ÿ 100001 - 100100)</h3>
            <button onclick="generateAndLoadParticipants(100)">é‡æ–°ç”¢ç”Ÿ 100 ç­†æ¨¡æ“¬è³‡æ–™</button>
        </div>
    </div>
</div>

<div id="version-display">æŠ½çç³»çµ± V4.5 (ä¿®æ­£ç‰ˆ)</div>

<script>
    // ===============================================
    // --- ç³»çµ±è³‡æ–™æ¨¡æ“¬èˆ‡åˆå§‹åŒ– ---
    // ===============================================
    let systemDB = {
        currentEventId: null,
        events: {}
    };

    function generateDummyParticipants(count = 100) {
        const departments = ["æ¥­å‹™éƒ¨", "ç ”ç™¼éƒ¨", "è¡ŒéŠ·éƒ¨", "è¡Œæ”¿éƒ¨", "è²¡å‹™éƒ¨", "äººè³‡éƒ¨"];
        const names = ["é™³", "æ—", "ç‹", "å¼µ", "æ", "å³", "åŠ‰", "é»ƒ", "æ¥Š", "å¾"];
        const participants = [];
        for (let i = 1; i <= count; i++) {
            const employeeId = (100000 + i).toString().padStart(6, '0');
            const name = names[i % names.length] + ["å¤§", "å°", "ç¾", "å¼·", "é›…", "åœ‹"][i % 6] + "æ˜";
            const dept = departments[i % departments.length];
            participants.push({ employeeId, name, dept });
        }
        return participants;
    }

    function initializeDB() {
        if (localStorage.getItem('systemDB')) {
            systemDB = JSON.parse(localStorage.getItem('systemDB'));
            
            // V4.23 çµæ§‹å‡ç´šï¼šç¢ºä¿æ¯å€‹æ´»å‹•éƒ½æœ‰å¿…è¦çš„çµæ§‹
            Object.values(systemDB.events).forEach(event => {
                if (!event.participants || event.participants.length !== 100) {
                    event.participants = generateDummyParticipants(100);
                }
                if (!event.adminList) {
                    event.adminList = [];
                }
                if (!event.winners) {
                    event.winners = [];
                }
                
                // çé …é †åºçµæ§‹å‡ç´š (V4.23 Final)
                if (!event.prizeOrder || event.prizeOrder.length === 0) {
                    event.prizeOrder = Object.keys(event.prizes || {});
                } else {
                    // ç¢ºä¿ prizeOrder åŒ…å«æ‰€æœ‰ pizes çš„ key ä¸”æ²’æœ‰å­¤ç«‹ key
                    const allPrizeIds = Object.keys(event.prizes || {});
                    event.prizeOrder = event.prizeOrder.filter(id => allPrizeIds.includes(id));
                    allPrizeIds.forEach(id => {
                        if (!event.prizeOrder.includes(id)) {
                            event.prizeOrder.push(id);
                        }
                    });
                }
            });
        } 
        
        // å¦‚æœæ²’æœ‰ä»»ä½•æ´»å‹•ï¼Œå‰‡å»ºç«‹é è¨­æ´»å‹•
        if (Object.keys(systemDB.events).length === 0) {
            const defaultId = 'EVT' + Date.now();
            systemDB.currentEventId = defaultId;
            systemDB.events[defaultId] = {
                name: "2026 åˆå§‹æ´»å‹•",
                allowDuplicateWin: false,
                prizes: {
                    'P001': { id: 'P001', name: 'é ­ç', content: '55å‹é›»è¦–', totalQty: 3, remainingQty: 3, weight: 1 },
                    'P002': { id: 'P002', name: 'äºŒç', content: 'ç¾é‡‘ 10000', totalQty: 10, remainingQty: 10, weight: 1 },
                },
                prizeOrder: ['P001', 'P002'], // V4.23 Final: çé …é †åº
                participants: generateDummyParticipants(100),
                winners: [
                    { id: 'WIN001', employeeId: '100005', name: 'æå¤§æ˜', prizeId: 'P001', prizeName: 'é ­ç', adminId: 'ADM1', adminName: 'ç¸½ç¶“ç†', winningTime: Date.now() - 50000 },
                    { id: 'WIN002', employeeId: '100001', name: 'é™³å¤§æ˜', prizeId: 'P002', prizeName: 'äºŒç', adminId: 'ADM2', adminName: 'å‰¯ç¸½', winningTime: Date.now() - 40000 },
                    { id: 'WIN003', employeeId: '100010', name: 'å¾ç¾å©·', prizeId: 'P002', prizeName: 'äºŒç', adminId: 'ADM2', adminName: 'å‰¯ç¸½', winningTime: Date.now() - 30000 },
                ],
                adminList: [
                    { id: 'ADM1', name: 'ç¸½ç¶“ç†', initialChances: 3, remainingChances: 3 },
                    { id: 'ADM2', name: 'å‰¯ç¸½', initialChances: 5, remainingChances: 5 }
                ],
            };
        }

        if (!systemDB.currentEventId && Object.keys(systemDB.events).length > 0) {
            systemDB.currentEventId = Object.keys(systemDB.events)[0];
        }

        saveDB();
        updateFrontendControls();
        updateBackendDisplay();
    }

    function saveDB() {
        localStorage.setItem('systemDB', JSON.stringify(systemDB));
    }

    // ===============================================
    // --- å¾Œå°ç®¡ç†é‚è¼¯ ---
    // ===============================================

    function getCurrentEvent() {
        return systemDB.events[systemDB.currentEventId];
    }

    function loadEventData() {
        const eventSelect = document.getElementById('eventSelect');
        const currentEventSelect = document.getElementById('currentEventSelect');

        systemDB.currentEventId = eventSelect.value || currentEventSelect.value;
        saveDB();
        updateFrontendControls();
        updateBackendDisplay();
    }

    function addEvent() {
        const name = document.getElementById('newEventName').value.trim();
        if (!name) {
            alert("è«‹è¼¸å…¥æ´»å‹•åç¨±ã€‚");
            return;
        }
        const newId = 'EVT' + Date.now();
        systemDB.events[newId] = {
            name: name,
            allowDuplicateWin: false,
            prizes: {},
            prizeOrder: [],
            participants: generateDummyParticipants(100),
            winners: [],
            adminList: [],
        };
        systemDB.currentEventId = newId;
        saveDB();
        document.getElementById('newEventName').value = '';
        updateFrontendControls();
        updateBackendDisplay();
    }
    
    function updateEventSetting() {
         const event = getCurrentEvent();
         if (!event) return;
         const allowDuplicate = document.getElementById('allowDuplicateWin').value === 'true';
         event.allowDuplicateWin = allowDuplicate;
         saveDB();
         alert("æ´»å‹•è¨­å®šå·²æ›´æ–°ï¼");
         updateBackendDisplay();
    }

    function deleteAllWinners() {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ´»å‹•ä¸­çš„æ‰€æœ‰ä¸­çç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;
        
        Object.values(systemDB.events).forEach(event => {
            event.winners = [];
            // é‡ç½®çé …å‰©é¤˜æ•¸é‡
            Object.values(event.prizes).forEach(p => {
                p.remainingQty = p.totalQty;
            });
            // é‡ç½®é•·å®˜å‰©é¤˜æ¬¡æ•¸
            event.adminList.forEach(a => {
                a.remainingChances = a.initialChances;
            });
        });
        
        saveDB();
        alert("æ‰€æœ‰ä¸­çç´€éŒ„å·²æ¸…é™¤ï¼Œæ‰€æœ‰çé …å’Œé•·å®˜æ¬¡æ•¸å·²é‡ç½®ã€‚");
        updateFrontendControls();
        updateBackendDisplay();
    }


    function addPrize() {
        const event = getCurrentEvent();
        if (!event) { alert("è«‹å…ˆå»ºç«‹æˆ–é¸æ“‡æ´»å‹•ã€‚"); return; }
        const name = document.getElementById('prizeName').value.trim();
        const content = document.getElementById('prizeContent').value.trim();
        const quantity = parseInt(document.getElementById('prizeQuantity').value);
        const weight = parseInt(document.getElementById('prizeWeight').value) || 1;

        if (!name || !content || isNaN(quantity) || quantity <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„çé …åç¨±ã€å…§å®¹å’Œæ•¸é‡ã€‚");
            return;
        }

        const newId = 'P' + Date.now();
        event.prizes[newId] = { id: newId, name, content, totalQty: quantity, remainingQty: quantity, weight: weight };
        event.prizeOrder.push(newId); // V4.23 Final: åŠ å…¥é †åºé™£åˆ—
        saveDB();
        document.getElementById('prizeName').value = '';
        document.getElementById('prizeContent').value = '';
        document.getElementById('prizeQuantity').value = '1';
        updateFrontendControls();
        updateBackendDisplay();
    }

    function deletePrize(prizeId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤çé …å—ï¼Ÿç›¸é—œä¸­çç´€éŒ„å°‡æœƒä¿ç•™ï¼Œä½†çé …æœƒå¾æ¸…å–®ä¸­ç§»é™¤ã€‚")) return;
        const event = getCurrentEvent();
        delete event.prizes[prizeId];
        event.prizeOrder = event.prizeOrder.filter(id => id !== prizeId); // V4.23 Final: å¾é †åºä¸­ç§»é™¤
        saveDB();
        updateFrontendControls();
        updateBackendDisplay();
    }

    function updatePrizeQty(prizeId, newQtyElement) {
        const event = getCurrentEvent();
        const prize = event.prizes[prizeId];
        const newTotalQty = parseInt(newQtyElement.value);
        if (isNaN(newTotalQty) || newTotalQty < 0) {
            alert("æ•¸é‡å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ•¸å­—ã€‚");
            newQtyElement.value = prize.totalQty;
            return;
        }
        const diff = newTotalQty - prize.totalQty;
        prize.totalQty = newTotalQty;
        prize.remainingQty += diff;
        if (prize.remainingQty < 0) prize.remainingQty = 0;
        saveDB();
        updateFrontendControls();
        updateBackendDisplay();
    }
    
    // V4.23 Final: ç§»å‹•çé …é †åº
    function movePrize(prizeId, direction) {
        const event = getCurrentEvent();
        const order = event.prizeOrder;
        const index = order.indexOf(prizeId);
        if (index === -1) return;

        let newIndex = index + (direction === 'up' ? -1 : 1);
        if (newIndex < 0 || newIndex >= order.length) return;

        // ES6 é™£åˆ—è§£æ§‹äº¤æ›å…ƒç´ 
        [order[index], order[newIndex]] = [order[newIndex], order[index]];

        saveDB();
        updateFrontendControls();
        updateBackendDisplay();
    }

    function addAdminChances() {
        const event = getCurrentEvent();
        const name = document.getElementById('adminName').value.trim();
        const chances = parseInt(document.getElementById('adminChances').value);

        if (!name || chances <= 0 || isNaN(chances)) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é•·å®˜å§“åå’ŒæŠ½çæ¬¡æ•¸ã€‚");
            return;
        }

        let admin = event.adminList.find(a => a.name === name);
        if (admin) {
            admin.initialChances += chances;
            admin.remainingChances += chances;
        } else {
            const newId = 'ADM' + Date.now();
            event.adminList.push({ id: newId, name: name, initialChances: chances, remainingChances: chances });
        }

        saveDB();
        document.getElementById('adminName').value = '';
        document.getElementById('adminChances').value = '1';
        updateFrontendControls();
        updateBackendDisplay();
    }

    function deleteAdminChance(adminId) {
        if (!confirm("ç¢ºå®šè¦ç§»é™¤æ­¤é•·å®˜åŠå…¶æ‰€æœ‰æŠ½çæ¬¡æ•¸å—ï¼Ÿ")) return;
        const event = getCurrentEvent();
        const index = event.adminList.findIndex(a => a.id === adminId);
        if (index !== -1) {
            event.adminList.splice(index, 1);
            saveDB();
            updateFrontendControls();
            updateBackendDisplay();
        }
    }
    
    function deleteWinner(winnerId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤ä¸­çç´€éŒ„å—ï¼Ÿ")) return;
        const event = getCurrentEvent();
        const winnerIndex = event.winners.findIndex(w => w.id === winnerId);

        if (winnerIndex !== -1) {
            const winner = event.winners[winnerIndex];
            const prize = event.prizes[winner.prizeId];
            const admin = event.adminList.find(a => a.id === winner.adminId);
            
            // æ­¸é‚„çé …æ•¸é‡
            if (prize && prize.remainingQty < prize.totalQty) {
                 prize.remainingQty += 1;
            }

            // æ­¸é‚„é•·å®˜æ¬¡æ•¸
            if (admin && admin.remainingChances < admin.initialChances) {
                admin.remainingChances += 1;
            } else {
                console.warn(`ç„¡æ³•æ‰¾åˆ° Admin ID: ${winner.adminId} ä¾†æ­¸é‚„æ¬¡æ•¸ã€‚`);
            }
            
            event.winners.splice(winnerIndex, 1);
            saveDB();
            updateFrontendControls();
            updateBackendDisplay();
        }
    }

    function generateAndLoadParticipants(count) {
        if (!confirm(`ç¢ºå®šè¦é‡æ–°ç”¢ç”Ÿ ${count} ç­†æ¨¡æ“¬åƒè³½è€…æ¸…å–®å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰æ¸…å–®ã€‚`)) return;
        const event = getCurrentEvent();
        event.participants = generateDummyParticipants(count);
        saveDB();
        alert(`${count} ç­†æ¨¡æ“¬åƒè³½è€…è³‡æ–™å·²ç”¢ç”Ÿä¸¦è¼‰å…¥ã€‚`);
        updateFrontendControls();
        updateBackendDisplay();
    }

    function updateBackendDisplay() {
        const event = getCurrentEvent();
        if (!event) {
            document.getElementById('prizesTable').innerHTML = '<tr><td colspan="7">æ²’æœ‰æ´»å‹•è³‡æ–™</td></tr>';
            document.getElementById('adminListTable').innerHTML = '<tr><td colspan="4">æ²’æœ‰æ´»å‹•è³‡æ–™</td></tr>';
            document.getElementById('winnersTable').innerHTML = '<tr><td colspan="6">æ²’æœ‰æ´»å‹•è³‡æ–™</td></tr>';
            return;
        }

        // 1. æ´»å‹•è¨­å®š
        document.getElementById('currentEventSelect').innerHTML = Object.keys(systemDB.events).map(id => 
            `<option value="${id}" ${id === systemDB.currentEventId ? 'selected' : ''}>${systemDB.events[id].name}</option>` 
        ).join('');
        document.getElementById('allowDuplicateWin').value = event.allowDuplicateWin.toString();

        // 2. çé …åˆ—è¡¨ (V4.23 Final: ä½¿ç”¨ prizeOrder é †åº)
        const prizesTableBody = document.getElementById('prizesTable');
        const prizeCount = event.prizeOrder.length;
        prizesTableBody.innerHTML = event.prizeOrder.map((prizeId, index) => {
            const p = event.prizes[prizeId];
            return `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.content}</td>
                    <td>
                        <input type="number" value="${p.totalQty}" min="0" onchange="updatePrizeQty('${p.id}', this)">
                    </td>
                    <td>${p.remainingQty}</td>
                    <td>${p.weight}</td>
                    <td>
                        <div class="prize-move-buttons">
                            <button class="move-btn" onclick="movePrize('${p.id}', 'up')" ${index === 0 ? 'disabled' : ''}>â¬†ï¸</button>
                            <button class="move-btn" onclick="movePrize('${p.id}', 'down')" ${index === prizeCount - 1 ? 'disabled' : ''}>â¬‡ï¸</button>
                        </div>
                    </td>
                    <td>
                        <button onclick="deletePrize('${p.id}')" class="delete-btn">åˆªé™¤</button>
                    </td>
                </tr>
            `;
        }).join('');

        // 3. é•·å®˜åˆ—è¡¨
        const adminListTableBody = document.getElementById('adminListTable');
        adminListTableBody.innerHTML = event.adminList.map(a => `
            <tr>
                <td>${a.name}</td>
                <td>${a.initialChances}</td>
                <td>${a.remainingChances}</td>
                <td>
                    <button onclick="deleteAdminChance('${a.id}')" class="delete-btn">ç§»é™¤</button>
                </td>
            </tr>
        `).join('');

        // 4. ä¸­çæ¸…å–®ç¯©é¸
        const winnerPrizeFilter = document.getElementById('winnerPrizeFilter');
        const currentFilterId = winnerPrizeFilter.value;
        winnerPrizeFilter.innerHTML = `<option value="all">æ‰€æœ‰çé … (${event.winners.length})</option>` +
            event.prizeOrder.map(id => {
                const p = event.prizes[id];
                const count = event.winners.filter(w => w.prizeId === id).length;
                return `<option value="${p.id}" ${p.id === currentFilterId ? 'selected' : ''}>${p.name} (${count})</option>`;
            }).join('');
        if (winnerPrizeFilter.value !== currentFilterId) {
             winnerPrizeFilter.value = 'all'; // é è¨­é¸æ“‡ 'all'
        }

        // 5. ä¸­çæ¸…å–®è¡¨æ ¼
        const winnersTableBody = document.getElementById('winnersTable');
        const filteredWinners = winnerPrizeFilter.value === 'all'
            ? event.winners
            : event.winners.filter(w => w.prizeId === winnerPrizeFilter.value);

        winnersTableBody.innerHTML = filteredWinners.map(w => {
            const participant = event.participants.find(p => p.employeeId === w.employeeId) || {};
            const prize = event.prizes[w.prizeId] || {};
            const admin = event.adminList.find(a => a.id === w.adminId) || {};
            const timeStr = new Date(w.winningTime).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            return `
                <tr>
                    <td>${timeStr}</td>
                    <td>${w.employeeId}</td>
                    <td>${w.name} (${participant.dept || 'N/A'})</td>
                    <td>${prize.name || w.prizeName}</td>
                    <td>${admin.name || w.adminName}</td>
                    <td>
                        <button onclick="deleteWinner('${w.id}')" class="delete-btn" style="min-width: unset;">ç§»é™¤</button>
                    </td>
                </tr>
            `;
        }).reverse().join(''); // æœ€æ–°çš„ä¸­çç´€éŒ„é¡¯ç¤ºåœ¨æœ€ä¸Šæ–¹
    }


    // ===============================================
    // --- å‰å°æŠ½çé‚è¼¯ ---
    // ===============================================

    const resultBox = document.getElementById('resultBox');
    const placeholder = document.getElementById('placeholder');
    const drawButton = document.getElementById('drawButton');
    const drawCountInput = document.getElementById('drawCount');
    const displaySecondsInput = document.getElementById('displaySeconds');
    const leftMarquee = document.getElementById('leftMarquee');
    const rightMarquee = document.getElementById('rightMarquee');
    const lottoDrum = document.getElementById('lotto-drum');
    const lottoDrumResults = document.getElementById('lotto-drum-results');

    let isDrawing = false;
    let batchTimeoutId = null; // Changed to Timeout to avoid confusion with setInterval
    let marqueeIntervalId = null;

    function updateFrontendControls() {
        const event = getCurrentEvent();
        if (!event) return;

        // 1. æ´»å‹•ä¸‹æ‹‰é¸å–®
        const eventSelect = document.getElementById('eventSelect');
        eventSelect.innerHTML = Object.keys(systemDB.events).map(id => 
            `<option value="${id}" ${id === systemDB.currentEventId ? 'selected' : ''}>${systemDB.events[id].name}</option>` 
        ).join('');

        // 2. é•·å®˜é¸æ“‡é¸å–®
        const adminSelect = document.getElementById('adminSelect');
        adminSelect.innerHTML = event.adminList
            .filter(a => a.remainingChances > 0)
            .map(a => `<option value="${a.id}">${a.name} (å‰© ${a.remainingChances})</option>`
        ).join('');
        if (adminSelect.options.length === 0) {
            adminSelect.innerHTML = '<option value="">è«‹è¨­å®šé•·å®˜æŠ½çæ¬¡æ•¸</option>';
        }

        // 3. çé …é¸æ“‡é¸å–® (V4.23 Final: ä½¿ç”¨ prizeOrder é †åº)
        const prizeSelect = document.getElementById('prizeSelect');
        const availablePrizes = event.prizeOrder
            .map(id => event.prizes[id])
            .filter(p => p && p.remainingQty > 0);
        
        const selectedPrizeId = prizeSelect.value;
        prizeSelect.innerHTML = availablePrizes
            .map(p => `<option value="${p.id}" ${p.id === selectedPrizeId ? 'selected' : ''}>${p.name}: ${p.content} (å‰© ${p.remainingQty})</option>`
        ).join('');

        if (prizeSelect.value !== selectedPrizeId) {
            prizeSelect.value = prizeSelect.options[0] ? prizeSelect.options[0].value : '';
        }

        // 4. æŠ½çæ¬¡æ•¸ä¸Šé™
        const totalChances = event.adminList.reduce((sum, admin) => sum + admin.remainingChances, 0);
        if (drawCountInput) {
            // è¨ˆç®—å¯æŠ½çæ•¸é‡çš„ä¸Šé™ï¼šçé …å‰©é¤˜æ•¸é‡ã€é•·å®˜å‰©é¤˜æ¬¡æ•¸ã€æœ€å¤§å€¼ 10 ä¸‰è€…å–æœ€å°
            const selectedPrize = availablePrizes.find(p => p.id === prizeSelect.value);
            const prizeMax = selectedPrize ? selectedPrize.remainingQty : 0;
            
            let maxDraws = Math.min(10, prizeMax);
            
            const adminId = document.getElementById('adminSelect').value;
            if (adminId) {
                const admin = event.adminList.find(a => a.id === adminId);
                if (admin) {
                     maxDraws = Math.min(maxDraws, admin.remainingChances);
                }
            } else {
                 // å¦‚æœæ˜¯ç³»çµ±æŠ½çï¼Œé•·å®˜æ¬¡æ•¸ä¸å½±éŸ¿æŠ½çæ•¸é‡
            }

            drawCountInput.max = maxDraws;
            if (parseInt(drawCountInput.value) > maxDraws || parseInt(drawCountInput.value) < 1) {
                drawCountInput.value = maxDraws > 0 ? 1 : 0;
            } else if (drawCountInput.value === '0' && maxDraws > 0) {
                 drawCountInput.value = 1;
            }
        }
        
        resetSystem();
    }

    function resetSystem() {
        if (batchTimeoutId) {
            clearTimeout(batchTimeoutId);
            batchTimeoutId = null;
        }
        if (marqueeIntervalId) {
             clearInterval(marqueeIntervalId);
             marqueeIntervalId = null;
        }

        isDrawing = false;
        drawButton.disabled = false;
        drawButton.textContent = 'ğŸ‰ é–‹å§‹æŠ½ç ğŸ‰';
        
        resultBox.classList.add('hidden');
        placeholder.classList.remove('hidden');
        
        document.getElementById('leftMarqueeSidebar').classList.remove('disabled-interaction');
        document.getElementById('rightMarqueeSidebar').classList.remove('disabled-interaction');

        // æ¸…ç†æ‹‰éœ¸æ©Ÿå’Œæ–çæ©Ÿç•«é¢
        document.getElementById('slot-container').style.display = 'none';
        document.getElementById('lotto-container').style.display = 'none';
        lottoDrum.classList.remove('spinning', 'slow-stop');
        lottoDrumResults.innerHTML = '';
        
        // æ‹‰éœ¸æ©Ÿå®¹å™¨å…§å®¹ä¹Ÿæ¸…ç©º
        document.getElementById('slot-container').innerHTML = '';
    }

    // è¼”åŠ©å‡½æ•¸: é¡¯ç¤ºæœ€çµ‚çµæœ 
    function showFinalResult(result, isBatch = false, hideOnly = false) {
        if (hideOnly || !result) {
            resultBox.classList.add('hidden');
            if (!isDrawing) placeholder.classList.remove('hidden'); 
            return;
        }

        document.getElementById('winningPrize').textContent = result.prizeName;
        document.getElementById('winningName').textContent = result.name + ` (${result.employeeId})`;
        document.getElementById('winningDetails').textContent = `æ‰€å±¬ï¼š${result.dept}`;
        
        placeholder.classList.add('hidden'); 
        resultBox.classList.remove('hidden');
    }

    // è¼”åŠ©å‡½æ•¸: é¡¯ç¤ºéœæ…‹æ‹‰éœ¸æ©Ÿçµæœ
    function displaySlotMachineStatic(employeeId) {
        const container = document.getElementById('slot-container');
        container.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å‹•ç•«
        container.style.display = 'flex';
        document.getElementById('lotto-container').style.display = 'none';

        const winningDigits = employeeId.toString().padStart(6, '0').split('');
        const reelHeight = 150;
        
        winningDigits.forEach((digit) => {
            const targetDigit = parseInt(digit);
            const reelContainer = document.createElement('div');
            reelContainer.className = 'reel-container';
            const reel = document.createElement('div');
            reel.className = 'reel';
            
            // åªéœ€è¦é¡¯ç¤ºç›®æ¨™æ•¸å­—æœ¬èº«
            reel.innerHTML = `<div class="reel-number">${targetDigit}</div>`;
            
            reelContainer.appendChild(reel);
            container.appendChild(reelContainer);
            
            // éœæ…‹å®šä½ï¼šå°‡æ•¸å­—ç§»åˆ°ä¸­å¤®
            const targetPosition = -targetDigit * reelHeight; // å‡è¨­æ•¸å­— 0-9 ä¾åºæ’åˆ—ï¼Œ0 åœ¨é ‚éƒ¨
            reel.style.transform = `translateY(0px)`;
            reel.style.transition = 'none';
            
        });
    }

    // è¼”åŠ©å‡½æ•¸: é¡¯ç¤ºéœæ…‹æ–çæ©Ÿçµæœ
    function displayLottoDrumStatic(employeeId) {
         document.getElementById('slot-container').style.display = 'none';
         const lottoContainer = document.getElementById('lotto-container');
         lottoContainer.style.display = 'flex';
         lottoDrum.classList.remove('spinning', 'slow-stop');
         lottoDrumResults.innerHTML = '';
         
         const winningDigits = employeeId.toString().padStart(6, '0').split('');

         winningDigits.forEach((digit, index) => {
             const ball = document.createElement('div');
             ball.className = 'lotto-ball-result';
             ball.textContent = digit;
             // ç§»é™¤å‹•ç•«ï¼Œç›´æ¥é¡¯ç¤º
             ball.style.animation = 'none'; 
             ball.style.transform = 'scale(1)'; 
             lottoDrumResults.appendChild(ball);
         });
    }

    // --- æ‹‰éœ¸æ©Ÿå‹•ç•«æ ¸å¿ƒ (FIXED: æ‹‰éœ¸æ©Ÿå…§å®¹æ¶ˆå¤±) ---
    function drawSlotMachine(winningEmployeeId, durationSeconds) {
        const container = document.getElementById('slot-container');
        container.innerHTML = '';
        container.style.display = 'flex';
        document.getElementById('lotto-container').style.display = 'none';

        const winningDigits = winningEmployeeId.toString().padStart(6, '0').split('');
        const reelCount = winningDigits.length;
        const reelHeight = 150;
        const totalCycles = 50;
        
        resultBox.classList.add('hidden');

        return new Promise(resolve => {
            winningDigits.forEach((digit, i) => {
                const targetDigit = parseInt(digit);
                const reelContainer = document.createElement('div');
                reelContainer.className = 'reel-container';
                const reel = document.createElement('div');
                reel.className = 'reel';

                const numbers = [];
                for(let j = 0; j < totalCycles; j++) {
                    for (let k = 0; k <= 9; k++) {
                        numbers.push(`<div class="reel-number">${k}</div>`);
                    }
                }
                // æœ€å¾ŒåŠ ä¸Šç›®æ¨™æ•¸å­—åºåˆ— (0-9)
                for (let k = 0; k <= 9; k++) {
                    numbers.push(`<div class="reel-number">${k}</div>`);
                }
                reel.innerHTML = numbers.join('');
                
                reelContainer.appendChild(reel); 
                container.appendChild(reelContainer); 

                const totalDuration = durationSeconds;
                const stopTime = totalDuration + (i * 0.2); // æ¯å€‹è»¸åœæ­¢æ™‚é–“ç•¥å»¶é²
                const stopDelay = (i * 100);

                setTimeout(() => {
                    // è¨ˆç®—ç›®æ¨™ä½ç½®ï¼šæ»¾å‹• cycles*10 å€‹æ•¸å­—ï¼Œå†åŠ ä¸Šç›®æ¨™æ•¸å­—çš„ä½ç§» (å¾ 0 é–‹å§‹ç®—)
                    // ç”±æ–¼æ•¸å­—æ˜¯å¾ 0-9 æ’åˆ—ï¼Œç›®æ¨™æ•¸å­—åœ¨åºåˆ—ä¸­çš„ç´¢å¼•å°±æ˜¯å…¶å€¼
                    const targetPosition = (totalCycles * 10 + targetDigit) * reelHeight;
                    
                    // è² æ•¸å› ç‚ºæ˜¯å¾€ä¸Šæ»¾å‹•
                    reel.style.transition = `transform ${stopTime}s cubic-bezier(0.25, 0.1, 0.25, 1.0)`;
                    reel.style.transform = `translateY(-${targetPosition}px)`;

                    // æœ€åä¸€ä¸ªè½¬è½´åœæ­¢å resolve
                    if (i === reelCount - 1) {
                        setTimeout(resolve, stopTime * 1000 + 500); // ç¢ºä¿è½‰å ´å‹•ç•«å®Œæˆ
                    }
                }, stopDelay);
            });
        });
    }
    
    // --- æ–çæ©Ÿå‹•ç•«æ ¸å¿ƒ ---
    const FIXED_ANIMATION_TIME = 4000; // ç¸½å‹•ç•«æ™‚é–“ 4.0 ç§’

    function drawLottoDrum(winningEmployeeId, durationSeconds) {
        document.getElementById('slot-container').style.display = 'none';
        const lottoContainer = document.getElementById('lotto-container');
        lottoContainer.style.display = 'flex';
        lottoDrumResults.innerHTML = '';
        
        const winningDigits = winningEmployeeId.toString().padStart(6, '0').split('');
        const totalBalls = winningDigits.length;

        resultBox.classList.add('hidden');
        lottoDrum.classList.add('spinning'); // é–‹å§‹è½‰å‹•
        
        return new Promise(resolve => {
            // 1. é–‹å§‹æ…¢åœ
            setTimeout(() => {
                lottoDrum.classList.remove('spinning');
                lottoDrum.classList.add('slow-stop');
            }, FIXED_ANIMATION_TIME - 2500); // æå‰ 2.5 ç§’é–‹å§‹æ…¢åœ

            // 2. æ…¢åœçµæŸï¼Œçµæœçƒå½ˆå‡º
            setTimeout(() => {
                lottoDrum.classList.remove('slow-stop');
                let ballDelay = 200;
                let count = 0;
                
                winningDigits.forEach((digit, index) => {
                    setTimeout(() => {
                        const ball = document.createElement('div');
                        ball.className = 'lotto-ball-result';
                        ball.textContent = digit;
                        lottoDrumResults.appendChild(ball);
                        count++;

                        if (count === totalBalls) {
                            setTimeout(resolve, 800); // ç­‰å¾…æœ€å¾Œä¸€å€‹çƒå½ˆå‡ºå‹•ç•«å®Œæˆ
                        }
                    }, ballDelay);
                    ballDelay += 400;
                });
            }, FIXED_ANIMATION_TIME - 500); // çµæŸæ…¢åœï¼Œé–‹å§‹å½ˆçƒ (ç¸½è¨ˆ 3.5s)
        });
    }

    async function runAnimation(employeeId, type, duration) {
        if (type === 'slot') {
            return drawSlotMachine(employeeId, duration);
        } else if (type === 'lotto-drum') {
            return drawLottoDrum(employeeId, duration);
        } else {
            document.getElementById('slot-container').style.display = 'none';
            document.getElementById('lotto-container').style.display = 'none';
            return Promise.resolve();
        }
    }

    function getFrontendResult(dbRecord) {
        const event = getCurrentEvent();
        const participant = event.participants.find(p => p.employeeId === dbRecord.employeeId);
        const prize = event.prizes[dbRecord.prizeId];
        return {
            id: dbRecord.id,
            employeeId: dbRecord.employeeId,
            name: dbRecord.name,
            dept: participant ? participant.dept : 'æœªçŸ¥éƒ¨é–€',
            prizeName: prize ? prize.name + ': ' + prize.content : 'æœªçŸ¥çé …',
            winningTime: dbRecord.winningTime
        };
    }

    // è·‘é¦¬ç‡ˆæ›´æ–° (V4.23: ä¿®æ­£æ¸…å–®é¡¯ç¤ºå’Œå‹•ç•«é«˜äº®é‚è¼¯)
    function updateWinnerLists(winnerResult, clear = false, filteredWinners = null, winnerToHighlightId = null) {
        let event = getCurrentEvent();
        const currentPrizeId = document.getElementById('prizeSelect').value;
        let winnersToDisplay = filteredWinners || event.winners.filter(w => w.prizeId === currentPrizeId);

        if (clear) {
            leftMarquee.innerHTML = '';
            rightMarquee.innerHTML = '';
            return;
        }

        let displayWinners = [...winnersToDisplay].sort((a, b) => a.winningTime - b.winningTime);

        const renderList = (container, sidebarId) => {
            container.innerHTML = displayWinners.map((w) => {
                const prize = event.prizes[w.prizeId];
                const highlightClass = winnerToHighlightId && w.id === winnerToHighlightId ? ' focus-animate' : '';
                return `<div id="${sidebarId}-winner-${w.id}" class="marquee-item${highlightClass}" onclick="startMarqueePlayback('${w.id}')"> 
                    <strong>${w.name} (${w.employeeId})</strong> 
                    <span>[${prize ? prize.name : 'æœªçŸ¥'}]</span>
                </div>`;
            }).join('');
            
            // V4.5: åˆ¤æ–·æ˜¯å¦éœ€è¦è‡ªå‹•æ»¾å‹•åˆ°è¢«é¸ä¸­çš„é …ç›®
            if (winnerToHighlightId) {
                const targetElement = document.getElementById(`${sidebarId}-winner-${winnerToHighlightId}`);
                if (targetElement) {
                    // targetElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // <--- ä¾ç…§ä½¿ç”¨è€…è¦æ±‚ï¼Œæ‹¿æ‰å¼·åˆ¶ç•«é¢å°é½Šæ•ˆæœ
                }
            }
        };

        renderList(leftMarquee, 'left');
        renderList(rightMarquee, 'right');
    }

    // V4.23 FINAL: è·‘é¦¬ç‡ˆæ’­æ”¾/è¼ªæ’­åŠŸèƒ½ (ç”¨æ–¼æ‰¹æ¬¡æˆ–å–®æ¬¡æŠ½çå¾Œçš„è¼ªæ’­å±•ç¤º)
    function startMarqueePlayback(winnerId = null) {
        if (isDrawing) return; // æŠ½çä¸­ç¦æ­¢æ‰‹å‹•æ’­æ”¾

        const event = getCurrentEvent();
        if (!event) return;

        const currentPrizeId = document.getElementById('prizeSelect').value;
        const allWinners = event.winners.filter(w => w.prizeId === currentPrizeId).sort((a, b) => a.winningTime - b.winningTime);
        const totalWinners = allWinners.length;
        
        let startIndex = winnerId ? allWinners.findIndex(w => w.id === winnerId) : 0;
        let currentIndex = startIndex;

        if (currentIndex === -1 || totalWinners === 0) return;

        isDrawing = true;
        drawButton.disabled = true;
        drawButton.textContent = 'è¼ªæ’­ä¸­...';
        document.getElementById('leftMarqueeSidebar').classList.add('disabled-interaction');
        document.getElementById('rightMarqueeSidebar').classList.add('disabled-interaction');

        const runPlayback = () => {
            if (currentIndex >= totalWinners) {
                showFinalResult(null, false, true);
                updateWinnerLists(null, false, allWinners); // çµæŸè¼ªæ’­ï¼Œèª¿ç”¨ resetSystem æ¸…ç†
                resetSystem();
                return;
            }

            const dbRecord = allWinners[currentIndex];
            const result = getFrontendResult(dbRecord);
            const animType = document.getElementById('animationType').value;

            // é¡¯ç¤ºéœæ…‹å‹•ç•«çµæœ
            if (animType === 'slot') {
                displaySlotMachineStatic(result.employeeId);
            } else if (animType === 'lotto-drum') {
                displayLottoDrumStatic(result.employeeId);
            } else {
                document.getElementById('slot-container').style.display = 'none';
                document.getElementById('lotto-container').style.display = 'none';
            }

            showFinalResult(result, true);
            updateWinnerLists(dbRecord, false, allWinners, dbRecord.id);
            currentIndex++;
        };

        // ç«‹å³åŸ·è¡Œç¬¬ä¸€æ¬¡æ’­æ”¾
        runPlayback();

        // è¨­å®šé–“éš”
        const displayTime = parseFloat(displaySecondsInput.value) * 1000;
        if (totalWinners > 0) {
            marqueeIntervalId = setInterval(runPlayback, displayTime);
        } else {
            // åªæœ‰ä¸€å€‹ä¸­çäººï¼Œé¡¯ç¤ºå¾Œç›´æ¥é‡ç½®
            setTimeout(resetSystem, displayTime + 1000);
        }
    }

    // V4.23 FINAL: æ–°å¢ - é€£çºŒæŠ½çé‚è¼¯ (æ¯æ¬¡éƒ½åŸ·è¡Œå‹•ç•«)
    async function runContinuousDraw(winnerRecordsDB, animType, displayTime) {
        let index = 0;
        const total = winnerRecordsDB.length;

        const runNextDraw = async () => {
            if (index >= total) {
                resetSystem();
                updateFrontendControls();
                return;
            }

            const dbRecord = winnerRecordsDB[index];
            const result = getFrontendResult(dbRecord);

            // 1. å‹•ç•«åŸ·è¡Œ (æ¯æ¬¡éƒ½è·‘å‹•ç•«)
            await runAnimation(result.employeeId, animType, 1.5);

            // 2. é¡¯ç¤ºçµæœ (ä¸æ¸…é™¤å‹•ç•«)
            showFinalResult(result, true);

            // 3. æ›´æ–°è·‘é¦¬ç‡ˆ
            updateWinnerLists(dbRecord, false, getCurrentEvent().winners.filter(w => w.prizeId === dbRecord.prizeId), dbRecord.id);
            index++;

            // 4. ä¸‹ä¸€æ¬¡æŠ½ç/é¡¯ç¤ºï¼šç­‰å¾…ã€Œé¡¯ç¤ºç§’æ•¸ã€
            batchTimeoutId = setTimeout(runNextDraw, displayTime * 1000);
        };
        
        await runNextDraw();
    }

    // V4.23 FINAL: æ–°å¢ - æ‰¹æ¬¡å±•ç¤ºé‚è¼¯ (åƒ…é¦–æ¬¡åŸ·è¡Œå‹•ç•«ï¼Œå¾ŒçºŒéœæ…‹é¡¯ç¤º)
    async function runBatchStaticDraw(winnerRecordsDB, animType, displayTime) {
        let index = 0;
        const total = winnerRecordsDB.length;

        const runNextDraw = async () => {
            if (index >= total) {
                resetSystem();
                updateFrontendControls();
                return;
            }

            const dbRecord = winnerRecordsDB[index];
            const result = getFrontendResult(dbRecord);

            if (index === 0) {
                // ç¬¬ä¸€æ¬¡ï¼šè·‘å®Œæ•´å‹•ç•«
                await runAnimation(result.employeeId, animType, 3);
            } else {
                // å¾ŒçºŒï¼šç›´æ¥é¡¯ç¤ºéœæ…‹çµæœ (è·³éå‹•ç•«)
                if (animType === 'slot') {
                    displaySlotMachineStatic(result.employeeId);
                } else if (animType === 'lotto-drum') {
                    displayLottoDrumStatic(result.employeeId);
                }
            }

            // é¡¯ç¤ºçµæœ
            showFinalResult(result, true);

            // æ›´æ–°è·‘é¦¬ç‡ˆ (åŒæ™‚é«˜äº®ç•¶å‰ä¸­çäºº)
            updateWinnerLists(dbRecord, false, getCurrentEvent().winners.filter(w => w.prizeId === dbRecord.prizeId), dbRecord.id);
            index++;

            // ä¸‹ä¸€æ¬¡æŠ½ç/å±•ç¤ºï¼šç­‰å¾…ã€Œé¡¯ç¤ºç§’æ•¸ã€
            batchTimeoutId = setTimeout(runNextDraw, displayTime * 1000);
        };

        await runNextDraw();
    }

    // æŠ½çé‚è¼¯
    async function startRaffle() {
        if (isDrawing) return;

        const prizeIdSelected = document.getElementById('prizeSelect').value;
        const adminIdSelected = document.getElementById('adminSelect').value;
        const drawTypeSelected = document.getElementById('drawType').value;
        const drawCount = parseInt(document.getElementById('drawCount').value);
        const event = getCurrentEvent();

        if (!event) {
             alert("æ²’æœ‰æ´»å‹•è³‡æ–™ã€‚"); 
             return; 
        }

        if (!prizeIdSelected) {
            alert("è«‹é¸æ“‡çé …ã€‚");
            return;
        }

        const prize = event.prizes[prizeIdSelected];
        const admin = adminIdSelected ? event.adminList.find(a => a.id === adminIdSelected) : null;

        if (prize.remainingQty < drawCount) {
             alert(`çé …ã€Œ${prize.name}ã€å‰©é¤˜æ•¸é‡ä¸è¶³ (å‰© ${prize.remainingQty} å€‹)ï¼Œç„¡æ³•æŠ½å– ${drawCount} å€‹ã€‚`);
             return;
        }
        
        if (adminIdSelected && (!admin || admin.remainingChances < drawCount)) {
            const available = admin ? admin.remainingChances : 0;
            alert(`è«‹é¸æ“‡æŠ½çé•·å®˜æˆ–æª¢æŸ¥å‰©é¤˜æ¬¡æ•¸ã€‚é¸å®šé•·å®˜ (å‰© ${available} æ¬¡) ä¸è¶³æŠ½ç ${drawCount} æ¬¡ã€‚`);
            return;
        }

        const animType = document.getElementById('animationType').value;
        const displayTime = parseFloat(displaySecondsInput.value);

        const winningRecords = [];
        for (let i = 0; i < drawCount; i++) {
            const record = selectRandomWinner(prizeIdSelected, adminIdSelected);
            if (record) {
                winningRecords.push(record);
            } else {
                alert("æŠ½çæ± å·²ç©ºæˆ–å·²ç„¡è¶³å¤ æ¬¡æ•¸ï¼");
                if (winningRecords.length > 0) break;
                isDrawing = false;
                drawButton.disabled = false;
                drawButton.textContent = 'ğŸ‰ é–‹å§‹æŠ½ç ğŸ‰';
                placeholder.classList.remove('hidden');
                updateFrontendControls();
                return;
            }
        }

        const winnerRecordsDB = winningRecords;
        
        isDrawing = true;
        drawButton.disabled = true;
        drawButton.textContent = 'æŠ½çä¸­...';
        placeholder.classList.add('hidden');

        if (drawTypeSelected === 'single') {
            const dbRecord = winnerRecordsDB[0];
            const result = getFrontendResult(dbRecord);
            
            await runAnimation(result.employeeId, animType, 3);
            
            showFinalResult(result);
            updateWinnerLists(dbRecord, false, null, dbRecord.id);
            
            setTimeout(() => {
                resetSystem();
                updateFrontendControls();
            }, displayTime * 1000);

        } else if (drawTypeSelected === 'continuous') {
            // é€£çºŒæŠ½ç
            await runContinuousDraw(winnerRecordsDB, animType, displayTime);
        } else if (drawTypeSelected === 'batch') {
            // æ‰¹æ¬¡å±•ç¤º
            await runBatchStaticDraw(winnerRecordsDB, animType, displayTime);
        }
    }

    // è¼”åŠ©å‡½æ•¸: éš¨æ©ŸæŠ½å–ä¸­çäºº
    function selectRandomWinner(prizeId, adminId) {
        const event = getCurrentEvent();
        const prize = event.prizes[prizeId];
        const admin = adminId ? event.adminList.find(a => a.id === adminId) : null;

        if (!prize || prize.remainingQty <= 0) {
            return null; // çé …æ•¸é‡å·²ç©º
        }
        if (admin && admin.remainingChances <= 0) {
             return null; // é•·å®˜æ¬¡æ•¸å·²ç©º
        }

        // ç¯©é¸å°šæœªä¸­ççš„åƒè³½è€…
        let eligibleParticipants = event.participants;
        if (!event.allowDuplicateWin) {
            const winnerEmployeeIds = new Set(event.winners.map(w => w.employeeId));
            eligibleParticipants = event.participants.filter(p => !winnerEmployeeIds.has(p.employeeId));
        }

        if (eligibleParticipants.length === 0) {
            return null;
        }

        // æ ¹æ“šæ¬Šé‡é¸æ“‡
        const weightedPool = [];
        eligibleParticipants.forEach(p => {
            for (let i = 0; i < prize.weight; i++) {
                weightedPool.push(p);
            }
        });

        if (weightedPool.length === 0) {
            return null;
        }

        const randomIndex = Math.floor(Math.random() * weightedPool.length);
        const selectedParticipant = weightedPool[randomIndex];

        if (!selectedParticipant) {
            return null;
        }

        // æ‰£é™¤çé …æ•¸é‡å’Œé•·å®˜æ¬¡æ•¸
        prize.remainingQty -= 1;
        if (admin) {
            admin.remainingChances -= 1;
        }

        const winnerRecord = {
            id: 'WIN' + Date.now() + Math.random().toString().slice(2,5),
            employeeId: selectedParticipant.employeeId,
            name: selectedParticipant.name,
            prizeId: prizeId,
            prizeName: prize.name,
            adminId: adminId,
            adminName: admin ? admin.name : 'ç³»çµ±',
            winningTime: Date.now(),
        };

        event.winners.push(winnerRecord);
        saveDB();

        return winnerRecord;
    }

    // åˆ‡æ›é é¢è¦–åœ–
    function switchView(view) {
        document.getElementById('frontend-view').style.display = view === 'frontend' ? 'flex' : 'none'; 
        document.getElementById('backend-view').style.display = view === 'backend' ? 'block' : 'none';

        document.getElementById('btn-frontend').classList.toggle('active', view === 'frontend');
        document.getElementById('btn-backend').classList.toggle('active', view === 'backend');

        if (view === 'backend') {
            updateBackendDisplay();
        } else {
            updateFrontendControls();
        }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initializeDB);
</script>

</body>
</html>